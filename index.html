<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Torn Territory Planner</title>
  <style>
    :root{
      --bg:#000;
      --panel-bg: rgba(17,17,17,.92);
      --panel-border: rgba(255,255,255,.14);
      --text: #f3f4f6;
      --muted: rgba(255,255,255,.72);
      --stroke: rgba(255,255,255,.10);
      --neighbor-stroke: rgba(34,197,94,.95);
      --selected-stroke: rgba(250,204,21,.98);
      --war-stroke: rgba(239,68,68,.98);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;}
    #app{display:grid;grid-template-columns:minmax(320px, 440px) 1fr;height:100vh;}
    #panel{background:var(--panel-bg);border-right:1px solid var(--panel-border);padding:14px;overflow:auto;}
    #mapwrap{display:flex;align-items:center;justify-content:center;overflow:hidden;}
    #mapinner{position:relative;width:min(100%, 1200px);aspect-ratio:725/720;}
    #mapimg{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;}
    #overlay{position:absolute;inset:0;width:100%;height:100%;}
    .h1{font-size:18px;font-weight:700;margin:0 0 10px 0;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    label{display:block;font-size:12px;color:var(--muted);margin:12px 0 6px;}
    select, textarea{
      width:100%;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      border-radius:10px;
      padding:10px;
      outline:none;
    }

    /* ✅ FIX: Improve dropdown readability in dark mode */
    select{
      background: rgba(255,255,255,.06);
      color: var(--text);
    }
    select option,
    select optgroup{
      background-color: #111;
      color: #f3f4f6;
    }
    select option:checked{
      background-color: #1f2937;
      color: #ffffff;
    }
    @media (prefers-color-scheme: light){
      select option,
      select optgroup{
        background-color: #ffffff;
        color: #111827;
      }
      select option:checked{
        background-color: #e5e7eb;
        color: #111827;
      }
    }
    /* ✅ END FIX */

    textarea{min-height:90px;resize:vertical;}
    button{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      border-radius:10px;
      padding:10px 12px;
      cursor:pointer;
    }
    button:hover{background:rgba(255,255,255,.12);}
    button.primary{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.35);}
    button.danger{background:rgba(239,68,68,.18);border-color:rgba(239,68,68,.35);}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:6px 10px;border:1px solid rgba(255,255,255,.14);
      border-radius:999px;background:rgba(255,255,255,.06);
      color:var(--muted);font-size:12px;
    }
    .swatch{width:10px;height:10px;border-radius:999px;display:inline-block;border:1px solid rgba(255,255,255,.25);}
    .small{font-size:12px;color:var(--muted);}
    .hr{height:1px;background:rgba(255,255,255,.12);margin:14px 0;}
    .list{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;color:rgba(255,255,255,.85);}

    /* SVG styling */
    #overlay svg{width:100%;height:100%;}
    #overlay polygon{
      fill:rgba(0,0,0,0);
      stroke:var(--stroke);
      stroke-width:1;
      cursor:pointer;
      vector-effect:non-scaling-stroke;
    }
    #overlay polygon:hover{stroke:rgba(255,255,255,.55);stroke-width:2;}
    #overlay polygon.owned{
      fill:var(--own-fill, rgba(255,255,255,.18));
      stroke:rgba(255,255,255,.25);
    }
    #overlay polygon.neighbor{stroke:var(--neighbor-stroke);stroke-width:3;}
    #overlay polygon.selected{stroke:var(--selected-stroke);stroke-width:4;}
    #overlay polygon.war{stroke:var(--war-stroke);stroke-width:4;}
    #overlay polygon.war.selected{stroke-width:5;}

    /* Owner labels */
    #overlay text.terr-label{
      fill: rgba(255,255,255,.92);
      font-size: 10px;
      font-weight: 800;
      text-anchor: middle;
      dominant-baseline: middle;
      paint-order: stroke;
      stroke: rgba(0,0,0,.65);
      stroke-width: 3px;
      pointer-events: none;
      user-select: none;
    }

    /* Neighbor arrows */
    #overlay g#arrows{ pointer-events:none; }
    #overlay line.nei-arrow{
      stroke: rgba(34,197,94,.95);
      stroke-width: 2px;
      vector-effect: non-scaling-stroke;
      opacity: .9;
    }

    @media (max-width: 900px){
      #app{grid-template-columns:1fr;grid-template-rows:auto 1fr;}
      #panel{border-right:none;border-bottom:1px solid var(--panel-border);}
      #mapinner{width:100%;}
    }
  </style>
</head>
<body>
<div id="app">
  <aside id="panel">
    <div class="row" style="justify-content:space-between;align-items:flex-start;">
      <div>
        <h1 class="h1">Territory Planner</h1>
        <div class="small">
          Click a tile → set owner + notes. Neighbors highlight (green) + arrows show links.
        </div>
        <div class="small" style="margin-top:6px;">
          Shared plan loads from <span class="kbd">Supabase</span>. “Save shared” requires an edit key.
        </div>
      </div>
      <div class="pill" title="Selected territory ID">
        <span class="swatch" id="selSwatch" style="background:rgba(255,255,255,.25)"></span>
        <span id="selId">None</span>
      </div>
    </div>

    <label for="ownerSel">Faction / Owner</label>
    <select id="ownerSel"></select>

    <label for="noteBox">Notes</label>
    <textarea id="noteBox" placeholder="Plan, targets, timers, calls..."></textarea>

    <div class="row" style="margin-top:10px;">
      <button class="primary" id="saveLocalBtn">Save (local)</button>
      <button class="primary" id="saveSharedBtn">Save shared (server)</button>
      <button class="danger" id="clearBtn" title="Clear owner + notes for selected territory (local override)">Clear</button>
    </div>

    <div class="small" style="margin-top:8px;">
      Local saves are stored in <span class="kbd">localStorage</span> (your browser).
      Shared saves go to <span class="kbd">Supabase</span> and update everyone.
    </div>

    <div class="hr"></div>

    <label>Neighbors</label>
    <div class="small" id="neighborsBox">Select a territory to see its neighbors.</div>

    <div class="hr"></div>

    <label>Shared plan</label>
    <div class="row">
      <button id="reloadSharedBtn">Reload shared now</button>
      <button id="forgetKeyBtn" class="danger" title="Forget edit key on this device">Forget edit key</button>
    </div>

    <div class="hr"></div>

    <label>Local data</label>
    <div class="row">
      <button id="exportLocalBtn">Export local overrides</button>
      <button id="importLocalBtn">Import local overrides</button>
      <button id="resetLocalBtn" class="danger">Reset local</button>
    </div>

    <div class="hr"></div>

    <label>Legend</label>
    <div class="list" id="legend"></div>

    <!-- ✅ NEW: Faction counter display -->
    <div class="hr"></div>
    <label>Faction counts</label>
    <div class="list" id="ownerCounts"></div>

    <div class="hr"></div>

    <label>Status</label>
    <div class="small">
      Overlay: <span id="overlayStatus">loading...</span><br/>
      Neighbors: <span id="graphStatus">not loaded</span><br/>
      Shared: <span id="sharedStatus">not loaded</span><br/>
      Last shared update: <span id="sharedUpdatedAt">—</span>
    </div>
  </aside>

  <main id="mapwrap">
    <div id="mapinner">
      <img id="mapimg" src="map.png" alt="map"/>
      <div id="overlay"></div>
    </div>
  </main>
</div>

<!-- Supabase client + your config.js (repo root) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>

<script>
  // ----------------------------
  // Helpers
  // ----------------------------
  const $ = (id) => document.getElementById(id);

  // ----------------------------
  // Config + Supabase client (IMPORTANT: we call it sb, NOT supabase)
  // ----------------------------
  const cfg = window.APP_CONFIG || {};
  const SUPABASE_URL = cfg.SUPABASE_URL;
  const SUPABASE_ANON_KEY = cfg.SUPABASE_ANON_KEY;

  let sb = null;
  if(!SUPABASE_URL || !SUPABASE_ANON_KEY){
    console.error("Missing window.APP_CONFIG. Ensure config.js is deployed and correct.");
    $("sharedStatus").textContent = "missing config.js";
  } else {
    sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  }

  const PLAN_ROW_ID = "shared";
  const EDIT_KEY_LS = "tornPlanner.editKey";

  // ----------------------------
  // Local overrides
  // ----------------------------
  const LS_KEY = "tornTerritoryPlanner.localOverrides.v1";

  // Default owners (your list)
  const defaultOwnerNames = ["ht","tnu","tgr","lads","vr","unt","koa","hh","vth","trc","ufd","jokerz","NWA","NL/OBN"];
  const defaultOwners = [
    { id: "unassigned", name: "Unassigned" },
    ...defaultOwnerNames.map(n => ({ id: n, name: n }))
  ];

  // ----------------------------
  // ✅ FULL COLOR CHART (EDIT THESE ANYTIME)
  // ----------------------------
  const OWNER_COLORS = {
    "NWA":   "rgba(0, 45, 160, 0.95)",   // dark blue
    "NL/OBN":"rgba(140, 30, 200, 0.95)", // purple

    "ht":     "rgba(255, 60, 60, 0.45)",
    "tnu":    "rgba(0, 220, 160, 0.45)",
    "tgr":    "rgba(255, 170, 0, 0.45)",
    "lads":   "rgba(255, 120, 0, 0.45)",
    "unt":    "rgba(140, 255, 0, 0.45)",
    "koa":    "rgba(0, 255, 230, 0.45)",
    "hh":     "rgba(200, 200, 200, 0.35)",
    "vth":    "rgba(255, 240, 0, 0.45)",
    "trc":    "rgba(255, 90, 200, 0.45)",
    "ufd":    "rgba(0, 255, 90, 0.45)",
    "jokerz": "rgba(255, 80, 140, 0.45)",
  };

  // Shared state (authoritative base from Supabase)
  let sharedState = { owners: defaultOwners, plan: {}, wars: [] };
  let sharedUpdatedAt = null;

  // Local draft overrides (only on this device)
  let localOverrides = loadLocalOverrides();

  // Neighbor graph
  let graph = null;

  // Overlay objects
  let polygons = [];
  let labelByTerrId = new Map();
  let centroidByTerrId = new Map();

  // UI refs
  const ownerSel = $("ownerSel");
  const noteBox = $("noteBox");
  const selId = $("selId");
  const selSwatch = $("selSwatch");
  const neighborsBox = $("neighborsBox");
  const legend = $("legend");
  const ownerCounts = $("ownerCounts"); // ✅ NEW

  let selectedId = null;

  function loadLocalOverrides(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return { plan: {} };
      const obj = JSON.parse(raw);
      return { plan: (obj.plan && typeof obj.plan === "object") ? obj.plan : {} };
    }catch{
      return { plan: {} };
    }
  }
  function saveLocalOverrides(){
    localStorage.setItem(LS_KEY, JSON.stringify(localOverrides));
  }

  function getEffectiveState(){
    return {
      owners: sharedState.owners,
      wars: sharedState.wars,
      plan: { ...sharedState.plan, ...localOverrides.plan }
    };
  }

  // ----------------------------
  // ✅ Use your manual colors first
  // ----------------------------
  function colorForOwnerId(id){
    if(OWNER_COLORS[id]) return OWNER_COLORS[id];

    let h = 0;
    for (let i = 0; i < id.length; i++) h = (h * 31 + id.charCodeAt(i)) >>> 0;
    const hue = h % 360;
    return `hsla(${hue}, 85%, 55%, 0.45)`;
  }

  function terrIdForPoly(poly){
    return String(poly.getAttribute("data-comp") || poly.id.replace(/^t/, ""));
  }

  function parsePoints(pointsStr){
    return pointsStr
      .trim()
      .split(/\s+/)
      .map(pair => pair.split(",").map(Number))
      .filter(p => p.length === 2 && Number.isFinite(p[0]) && Number.isFinite(p[1]));
  }

  function centroidOfPolygon(points){
    let x = 0, y = 0;
    for (const [px, py] of points) { x += px; y += py; }
    const n = points.length || 1;
    return [x / n, y / n];
  }

  function ensureLabels(svg){
    let g = svg.querySelector("g#labels");
    if(!g){
      g = document.createElementNS("http://www.w3.org/2000/svg", "g");
      g.setAttribute("id", "labels");
      svg.appendChild(g);
    }

    labelByTerrId.clear();
    for(const poly of polygons){
      const id = terrIdForPoly(poly);
      const pts = parsePoints(poly.getAttribute("points") || "");
      if(pts.length < 3) continue;

      const [cx, cy] = centroidOfPolygon(pts);

      const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
      t.classList.add("terr-label");
      t.setAttribute("data-terr", id);
      t.setAttribute("x", cx);
      t.setAttribute("y", cy);
      t.textContent = "";
      g.appendChild(t);

      labelByTerrId.set(id, t);
    }
  }

  function buildCentroidCache(){
    centroidByTerrId.clear();
    for(const poly of polygons){
      const id = terrIdForPoly(poly);
      const pts = parsePoints(poly.getAttribute("points") || "");
      if(pts.length < 3) continue;
      centroidByTerrId.set(id, centroidOfPolygon(pts));
    }
  }

  function ensureArrowLayer(svg){
    let defs = svg.querySelector("defs");
    if(!defs){
      defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
      svg.insertBefore(defs, svg.firstChild);
    }

    if(!svg.querySelector("#arrowhead")){
      const marker = document.createElementNS("http://www.w3.org/2000/svg", "marker");
      marker.setAttribute("id", "arrowhead");
      marker.setAttribute("markerWidth", "8");
      marker.setAttribute("markerHeight", "8");
      marker.setAttribute("refX", "7");
      marker.setAttribute("refY", "4");
      marker.setAttribute("orient", "auto");
      marker.setAttribute("markerUnits", "strokeWidth");

      const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
      path.setAttribute("d", "M0,0 L8,4 L0,8 Z");
      path.setAttribute("fill", "rgba(34,197,94,.95)");
      marker.appendChild(path);
      defs.appendChild(marker);
    }

    let g = svg.querySelector("g#arrows");
    if(!g){
      g = document.createElementNS("http://www.w3.org/2000/svg", "g");
      g.setAttribute("id", "arrows");
      const labels = svg.querySelector("g#labels");
      if(labels) svg.insertBefore(g, labels);
      else svg.appendChild(g);
    }
    return g;
  }

  function clearArrows(){
    const svg = document.querySelector("#overlay svg");
    const g = svg && svg.querySelector("g#arrows");
    if(g) g.innerHTML = "";
  }

  function drawNeighborArrows(selectedTerrId){
    clearArrows();
    if(!graph || !selectedTerrId) return;

    const svg = document.querySelector("#overlay svg");
    const g = ensureArrowLayer(svg);

    const from = centroidByTerrId.get(selectedTerrId);
    if(!from) return;

    const neigh = (graph[selectedTerrId] || graph[Number(selectedTerrId)] || []).map(String);
    const [x1,y1] = from;

    for(const nid of neigh){
      const to = centroidByTerrId.get(nid);
      if(!to) continue;

      const [x2,y2] = to;
      const dx = x2 - x1, dy = y2 - y1;
      const len = Math.hypot(dx, dy) || 1;

      const pad = 10;
      const sx = x1 + (dx/len)*pad;
      const sy = y1 + (dy/len)*pad;
      const ex = x2 - (dx/len)*pad;
      const ey = y2 - (dy/len)*pad;

      const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
      line.classList.add("nei-arrow");
      line.setAttribute("x1", sx);
      line.setAttribute("y1", sy);
      line.setAttribute("x2", ex);
      line.setAttribute("y2", ey);
      line.setAttribute("marker-end", "url(#arrowhead)");
      g.appendChild(line);
    }
  }

  async function loadSvgOverlay(){
    const res = await fetch("./territory_polygons_overlay.svg", { cache: "no-store" });
    if(!res.ok) throw new Error("territory_polygons_overlay.svg not found (check path/case)");
    const svgText = await res.text();

    $("overlay").innerHTML = `<svg viewBox="0 0 725 720" xmlns="http://www.w3.org/2000/svg">${svgText}</svg>`;

    const svg = document.querySelector("#overlay svg");
    polygons = Array.from(svg.querySelectorAll("polygon"));

    ensureLabels(svg);
    buildCentroidCache();
    ensureArrowLayer(svg);

    $("overlayStatus").textContent = "loaded";
  }

  async function tryLoadGraph(){
    try{
      const res = await fetch("./connections.json", { cache: "no-store" });
      if(!res.ok) throw new Error("connections.json not found");
      const payload = await res.json();
      graph = payload.territories_neighbors || payload;
      if(!graph || typeof graph !== "object") throw new Error("bad graph");
      $("graphStatus").textContent = "loaded";
    }catch{
      graph = null;
      $("graphStatus").textContent = "not loaded";
    }
  }

  function renderOwners(stateObj){
    ownerSel.innerHTML = "";
    for(const o of stateObj.owners){
      const opt = document.createElement("option");
      opt.value = o.id;
      opt.textContent = o.name;
      ownerSel.appendChild(opt);
    }
  }

  function renderLegend(stateObj){
    legend.innerHTML = "";
    for(const o of stateObj.owners){
      if(o.id === "unassigned") continue;
      const div = document.createElement("div");
      div.className = "pill";
      div.innerHTML = `<span class="swatch" style="background:${colorForOwnerId(o.id)}"></span><span>${o.name}</span>`;
      legend.appendChild(div);
    }
  }

  // ✅ NEW: build counts
  function computeOwnerCounts(stateObj){
    const counts = {};
    for(const o of stateObj.owners){
      counts[o.id] = 0;
    }

    for(const terrId in stateObj.plan){
      const entry = stateObj.plan[terrId];
      if(!entry || !entry.ownerId) continue;
      if(entry.ownerId === "unassigned") continue;
      if(counts[entry.ownerId] === undefined) counts[entry.ownerId] = 0;
      counts[entry.ownerId]++;
    }

    return counts;
  }

  // ✅ NEW: render counts
  function renderOwnerCounts(stateObj){
    if(!ownerCounts) return;

    const counts = computeOwnerCounts(stateObj);

    const items = stateObj.owners
      .filter(o => o.id !== "unassigned")
      .map(o => ({ owner: o, count: counts[o.id] || 0 }))
      .sort((a,b) => b.count - a.count || a.owner.id.localeCompare(b.owner.id));

    ownerCounts.innerHTML = "";
    for(const item of items){
      const div = document.createElement("div");
      div.className = "pill";
      div.title = `Territories owned by ${item.owner.name}`;

      div.innerHTML = `
        <span class="swatch" style="background:${colorForOwnerId(item.owner.id)}"></span>
        <span>${item.owner.name}: <b style="color:var(--text)">${item.count}</b></span>
      `;
      ownerCounts.appendChild(div);
    }
  }

  function applyPlanToMap(stateObj){
    for(const poly of polygons){
      const id = terrIdForPoly(poly);
      const entry = stateObj.plan[id];

      poly.classList.remove("owned");
      poly.style.removeProperty("--own-fill");
      poly.classList.toggle("war", (stateObj.wars || []).includes(id));

      if(entry && entry.ownerId && entry.ownerId !== "unassigned"){
        poly.classList.add("owned");
        poly.style.setProperty("--own-fill", colorForOwnerId(entry.ownerId));
      }

      const label = labelByTerrId.get(id);
      if(label){
        label.textContent = (entry && entry.ownerId && entry.ownerId !== "unassigned") ? entry.ownerId : "";
      }
    }

    // ✅ update counters whenever map changes
    renderOwnerCounts(stateObj);
  }

  function clearSelectionStyles(){
    polygons.forEach(p => p.classList.remove("selected", "neighbor"));
  }

  function setSelected(id){
    selectedId = id;
    selId.textContent = id || "None";
    clearSelectionStyles();

    if(!id){
      neighborsBox.textContent = "Select a territory to see its neighbors.";
      ownerSel.value = "unassigned";
      noteBox.value = "";
      selSwatch.style.background = "rgba(255,255,255,.25)";
      clearArrows();
      return;
    }

    const poly = polygons.find(p => terrIdForPoly(p) === id);
    if(poly) poly.classList.add("selected");

    const effective = getEffectiveState();
    const entry = effective.plan[id] || { ownerId: "unassigned", note: "" };

    ownerSel.value = entry.ownerId || "unassigned";
    noteBox.value = entry.note || "";

    selSwatch.style.background = (ownerSel.value === "unassigned")
      ? "rgba(255,255,255,.25)"
      : colorForOwnerId(ownerSel.value);

    if(!graph){
      neighborsBox.textContent = "Neighbor graph not loaded (connections.json missing).";
      clearArrows();
      return;
    }

    const neigh = graph[id] || graph[Number(id)] || [];
    const neighIds = neigh.map(String);
    neighborsBox.textContent = neighIds.length ? neighIds.join(", ") : "(none)";

    for(const p of polygons){
      if(neighIds.includes(terrIdForPoly(p))) p.classList.add("neighbor");
    }

    drawNeighborArrows(id);
  }

  function wireMapClicks(){
    polygons.forEach(poly => {
      poly.addEventListener("click", (e) => {
        e.preventDefault(); e.stopPropagation();
        setSelected(terrIdForPoly(poly));
      });
    });
    document.querySelector("#mapinner").addEventListener("click", () => setSelected(null));
  }

  // ----------------------------
  // Supabase shared load/save
  // ----------------------------
  async function loadSharedPlanFromSupabase(){
    if(!sb) throw new Error("Supabase not configured (config.js missing or invalid).");

    const { data, error } = await sb
      .from("plans")
      .select("data, updated_at")
      .eq("id", PLAN_ROW_ID)
      .single();

    if(error) throw error;

    sharedUpdatedAt = data?.updated_at || null;
    const shared = data?.data || { owners: [], plan: {}, wars: [] };

    sharedState = {
      owners: (shared.owners && shared.owners.length) ? shared.owners : defaultOwners,
      plan: (shared.plan && typeof shared.plan === "object") ? shared.plan : {},
      wars: Array.isArray(shared.wars) ? shared.wars.map(String) : []
    };

    $("sharedStatus").textContent = "loaded (supabase)";
    $("sharedUpdatedAt").textContent = sharedUpdatedAt ? new Date(sharedUpdatedAt).toLocaleString() : "—";

    renderOwners(sharedState);
    renderLegend(sharedState);
  }

  function getEditKey(){
    let k = localStorage.getItem("tornPlanner.editKey");
    if(!k){
      k = prompt("Enter edit key to save shared plan:");
      if(k) localStorage.setItem("tornPlanner.editKey", k);
    }
    return k || "";
  }

  async function saveSharedPlanToSupabase(){
    if(!sb) throw new Error("Supabase not configured (config.js missing or invalid).");

    const editKey = getEditKey();
    if(!editKey) throw new Error("No edit key provided.");

    const effective = getEffectiveState();
    const payload = {
      owners: effective.owners,
      plan: effective.plan,
      wars: effective.wars || []
    };

    const { error } = await sb.rpc("update_shared_plan", {
      edit_key: editKey,
      new_data: payload
    });

    if(error) throw error;
  }

  // ----------------------------
  // Buttons / events
  // ----------------------------
  $("saveLocalBtn").addEventListener("click", () => {
    if(!selectedId) return;

    const ownerId = ownerSel.value;
    const note = noteBox.value || "";

    if(ownerId === "unassigned" && !note.trim()){
      delete localOverrides.plan[selectedId];
    }else{
      localOverrides.plan[selectedId] = { ownerId, note };
    }

    saveLocalOverrides();
    applyPlanToMap(getEffectiveState());
    setSelected(selectedId);
  });

  $("clearBtn").addEventListener("click", () => {
    if(!selectedId) return;
    delete localOverrides.plan[selectedId];
    saveLocalOverrides();
    applyPlanToMap(getEffectiveState());
    setSelected(selectedId);
  });

  $("saveSharedBtn").addEventListener("click", async () => {
    try{
      await saveSharedPlanToSupabase();
      await loadSharedPlanFromSupabase();
      applyPlanToMap(getEffectiveState());
      setSelected(selectedId);
      alert("Saved to server.");
    }catch(e){
      console.error(e);
      alert("Save failed: " + (e?.message || e));
    }
  });

  $("reloadSharedBtn").addEventListener("click", async () => {
    try{
      await loadSharedPlanFromSupabase();
      applyPlanToMap(getEffectiveState());
      setSelected(selectedId);
    }catch(e){
      console.error(e);
      alert("Reload failed: " + (e?.message || e));
    }
  });

  $("forgetKeyBtn").addEventListener("click", () => {
    localStorage.removeItem("tornPlanner.editKey");
    alert("Edit key forgotten on this device.");
  });

  ownerSel.addEventListener("change", () => {
    selSwatch.style.background = (ownerSel.value === "unassigned")
      ? "rgba(255,255,255,.25)"
      : colorForOwnerId(ownerSel.value);
  });

  $("exportLocalBtn").addEventListener("click", () => {
    const payload = JSON.stringify(localOverrides, null, 2);
    const blob = new Blob([payload], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "local_overrides.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  $("importLocalBtn").addEventListener("click", () => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/json";
    input.onchange = async () => {
      const file = input.files && input.files[0];
      if(!file) return;
      try{
        const parsed = JSON.parse(await file.text());
        localOverrides = { plan: (parsed.plan && typeof parsed.plan === "object") ? parsed.plan : {} };
        saveLocalOverrides();
        applyPlanToMap(getEffectiveState());
        setSelected(selectedId);
      }catch{
        alert("Invalid JSON.");
      }
    };
    input.click();
  });

  $("resetLocalBtn").addEventListener("click", () => {
    if(!confirm("Reset local overrides on this device?")) return;
    localStorage.removeItem("tornTerritoryPlanner.localOverrides.v1");
    localOverrides = { plan: {} };
    applyPlanToMap(getEffectiveState());
    setSelected(selectedId);
  });

  // ----------------------------
  // Boot (overlay always loads even if Supabase fails)
  // ----------------------------
  (async () => {
    // 1) Overlay + map always
    try{
      renderOwners({ owners: defaultOwners });
      renderLegend({ owners: defaultOwners });

      await loadSvgOverlay();
      await tryLoadGraph();
      wireMapClicks();

      applyPlanToMap(getEffectiveState());
      setSelected(null);
    }catch(err){
      console.error("Overlay init failed:", err);
      $("overlayStatus").textContent = "ERROR (check console)";
      return;
    }

    // 2) Shared load (non-blocking)
    try{
      await loadSharedPlanFromSupabase();
      applyPlanToMap(getEffectiveState());
      setSelected(selectedId);
    }catch(err){
      console.warn("Shared load failed:", err);
      $("sharedStatus").textContent = "not loaded (supabase/config)";
    }

    // 3) Auto-refresh shared every 30s if Supabase configured
    setInterval(async () => {
      if(!sb) return;
      try{
        await loadSharedPlanFromSupabase();
        applyPlanToMap(getEffectiveState());
        setSelected(selectedId);
      }catch{
        // ignore
      }
    }, 30000);
  })();
</script>
</body>
</html>
