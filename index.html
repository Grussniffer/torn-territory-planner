<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Torn Territory Planner (Unofficial)</title>

  <!-- vis-network (graph rendering) -->
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

  <style>
    :root { --bg:#0b0f17; --panel:#121a27; --muted:#9fb0cc; --text:#e7eefc; --line:#233049; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    header { padding:14px 16px; border-bottom:1px solid var(--line); display:flex; gap:12px; align-items:center; }
    header h1 { font-size:14px; margin:0; font-weight:650; letter-spacing:.2px; }
    header .muted { color:var(--muted); font-size:12px; }
    main { display:grid; grid-template-columns: 360px 1fr; height: calc(100vh - 52px); }
    .panel { background:var(--panel); border-right:1px solid var(--line); padding:14px; overflow:auto; }
    .panel h2 { font-size:12px; margin:14px 0 6px; color:var(--muted); text-transform:uppercase; letter-spacing:.12em; }
    .row { display:flex; gap:8px; align-items:center; }
    .row > * { flex:1; }
    input, textarea, select, button {
      background:#0e1522; border:1px solid #22314c; color:var(--text);
      border-radius:10px; padding:10px 10px; font-size:13px; outline:none;
    }
    textarea { min-height:80px; resize:vertical; }
    button { cursor:pointer; font-weight:600; }
    button:hover { border-color:#3a5587; }
    .btns { display:flex; gap:8px; flex-wrap:wrap; }
    .pill {
      display:inline-flex; gap:8px; align-items:center; padding:6px 10px;
      border:1px solid #22314c; border-radius:999px; font-size:12px; color:var(--muted);
      background:#0e1522;
    }
    .swatch { width:10px; height:10px; border-radius:50%; background:#888; display:inline-block; }
    #canvasWrap { position:relative; }
    #network { width:100%; height:100%; background: #070a10; }
    #bgImg {
      position:absolute; inset:0; width:100%; height:100%; object-fit:contain;
      opacity:.35; pointer-events:none; display:none;
    }
    .small { font-size:12px; color:var(--muted); line-height:1.35; }
    .hr { height:1px; background:var(--line); margin:12px 0; }
    .list { display:flex; flex-direction:column; gap:8px; }
    .nodeLine { display:flex; gap:8px; align-items:center; }
    .nodeLine code { color:#cfe2ff; font-size:12px; }
  </style>
</head>
<body>
  <header>
    <h1>Torn Territory Planner (Unofficial)</h1>
    <span class="muted">Click territories to assign / add notes. Export JSON to share.</span>
  </header>

  <main>
    <aside class="panel">
      <div class="small">
        This is a generic planner. You can start with a small subset of territories and expand.
        If you can paste an adjacency list (connections), it will render the graph.
      </div>

      <h2>Team colors</h2>
      <div class="list" id="teamList"></div>
      <div class="row" style="margin-top:8px;">
        <input id="teamName" placeholder="Add team/person (e.g. Alpha)" />
        <input id="teamColor" type="color" value="#4f8cff" style="max-width:90px; padding:6px;" />
      </div>
      <div class="btns" style="margin-top:8px;">
        <button id="addTeamBtn">Add team</button>
        <button id="clearAssignmentsBtn">Clear assignments</button>
      </div>

      <div class="hr"></div>

      <h2>Selected territory</h2>
      <div class="small" id="selHint">Click a node on the map.</div>

      <div style="margin-top:8px;">
        <div class="nodeLine"><span class="swatch" id="selSwatch"></span><code id="selId">—</code></div>
        <div class="row" style="margin-top:8px;">
          <select id="assignSelect">
            <option value="">Unassigned</option>
          </select>
        </div>
        <textarea id="notes" placeholder="Notes (route, timing, who hits first, etc.)"></textarea>
        <div class="btns">
          <button id="saveNodeBtn">Save</button>
          <button id="togglePinBtn">Pin/unpin position</button>
        </div>
      </div>

      <div class="hr"></div>

      <h2>Data</h2>
      <div class="small">
        <b>Adjacency list format</b> (one line per territory):<br/>
        <code>A: B,C,D</code><br/>
        Use short IDs or names — whatever you prefer.
      </div>
      <textarea id="adj" placeholder="Paste adjacency list here..."></textarea>
      <div class="btns">
        <button id="buildBtn">Build / Rebuild graph</button>
        <button id="exportBtn">Export plan JSON</button>
        <button id="importBtn">Import plan JSON</button>
      </div>

      <div class="hr"></div>

      <h2>Background image (optional)</h2>
      <div class="small">Upload a screenshot of the Torn territory map, then drag nodes to match locations.</div>
      <div class="row" style="margin-top:8px;">
        <input id="bgUpload" type="file" accept="image/*" />
      </div>
      <div class="btns" style="margin-top:8px;">
        <button id="toggleBgBtn">Show/hide background</button>
      </div>

      <div class="hr"></div>

      <div class="small">
        Tip: Host this as a static page, then share the URL + exported JSON in Discord.
        Everyone imports the same JSON and you’re synced.
      </div>
    </aside>

    <section id="canvasWrap">
      <img id="bgImg" alt="background" />
      <div id="network"></div>
    </section>
  </main>

<script>
  // --- State ---
  const state = {
    teams: [
      { id: "alpha", name: "Alpha", color: "#4f8cff" },
      { id: "bravo", name: "Bravo", color: "#38d996" },
      { id: "charlie", name: "Charlie", color: "#ffb020" },
    ],
    nodes: new Map(),     // id -> { id,label, assignedTo, notes, x,y, fixed }
    edges: new Set(),     // "a|b" normalized
    selectedId: null,
    bgVisible: false
  };

  // --- Helpers ---
  const $ = (id) => document.getElementById(id);
  const normEdgeKey = (a,b) => [a,b].sort().join("|");
  const slug = (s) => (s || "").toLowerCase().trim().replace(/\s+/g,"-").replace(/[^a-z0-9\-]/g,"");

  function teamById(id) { return state.teams.find(t => t.id === id) || null; }

  function nodeColor(node) {
    if (!node.assignedTo) return { background: "#8a94a6", border: "#c5cedd" };
    const t = teamById(node.assignedTo);
    return t ? { background: t.color, border: "#ffffff" } : { background:"#8a94a6", border:"#c5cedd" };
  }

  // --- UI: teams ---
  function renderTeams() {
    const wrap = $("teamList");
    wrap.innerHTML = "";
    state.teams.forEach(t => {
      const div = document.createElement("div");
      div.className = "pill";
      div.innerHTML = `<span class="swatch" style="background:${t.color}"></span> ${t.name}`;
      wrap.appendChild(div);
    });

    const sel = $("assignSelect");
    const cur = sel.value;
    sel.innerHTML = `<option value="">Unassigned</option>` + state.teams.map(t => `<option value="${t.id}">${t.name}</option>`).join("");
    sel.value = cur;
  }

  $("addTeamBtn").addEventListener("click", () => {
    const name = $("teamName").value.trim();
    const color = $("teamColor").value;
    if (!name) return;
    const id = slug(name);
    if (state.teams.some(t => t.id === id)) return alert("Team already exists.");
    state.teams.push({ id, name, color });
    $("teamName").value = "";
    renderTeams();
    refreshGraphStyles();
  });

  $("clearAssignmentsBtn").addEventListener("click", () => {
    state.nodes.forEach(n => { n.assignedTo = ""; n.notes = n.notes || ""; });
    refreshGraphStyles();
    if (state.selectedId) loadSelected(state.selectedId);
  });

  // --- Parse adjacency list ---
  function parseAdjacency(text) {
    state.nodes.clear();
    state.edges.clear();

    const lines = (text || "").split("\n").map(l => l.trim()).filter(Boolean);
    for (const line of lines) {
      const [left, right] = line.split(":").map(s => (s || "").trim());
      if (!left) continue;
      const a = left;
      if (!state.nodes.has(a)) state.nodes.set(a, { id:a, label:a, assignedTo:"", notes:"", x:null, y:null, fixed:false });

      const neighbors = (right || "").split(",").map(s => s.trim()).filter(Boolean);
      for (const b of neighbors) {
        if (!state.nodes.has(b)) state.nodes.set(b, { id:b, label:b, assignedTo:"", notes:"", x:null, y:null, fixed:false });
        state.edges.add(normEdgeKey(a,b));
      }
    }
  }

  // --- Graph (vis-network) ---
  let network = null;
  let visNodes = null;
  let visEdges = null;

  function buildGraph() {
    parseAdjacency($("adj").value);

    // Create vis datasets
    visNodes = new vis.DataSet(Array.from(state.nodes.values()).map(n => ({
      id: n.id,
      label: n.label,
      color: nodeColor(n),
      x: n.x, y: n.y,
      fixed: n.fixed ? {x:true,y:true} : false
    })));

    visEdges = new vis.DataSet(Array.from(state.edges.values()).map(k => {
      const [from,to] = k.split("|");
      return { id:k, from, to };
    }));

    const container = $("network");
    const data = { nodes: visNodes, edges: visEdges };
    const options = {
      physics: { enabled: true, stabilization: false },
      interaction: { hover: true, multiselect: false },
      nodes: { shape: "dot", size: 14, font: { color: "#e7eefc" }, borderWidth: 2 },
      edges: { color: { color: "#2b3d60" }, width: 2, smooth: { type: "dynamic" } }
    };

    network = new vis.Network(container, data, options);

    network.on("click", (params) => {
      if (params.nodes.length) {
        const id = params.nodes[0];
        state.selectedId = id;
        loadSelected(id);
      }
    });

    // Save position after dragging
    network.on("dragEnd", () => {
      if (!network) return;
      const positions = network.getPositions();
      for (const [id, pos] of Object.entries(positions)) {
        const n = state.nodes.get(id);
        if (!n) continue;
        n.x = pos.x; n.y = pos.y;
      }
    });

    // Start with selection if any
    state.selectedId = null;
    $("selHint").textContent = "Click a node on the map.";
    $("selId").textContent = "—";
    $("notes").value = "";
    $("assignSelect").value = "";
    $("selSwatch").style.background = "#888";
  }

  function refreshGraphStyles() {
    if (!visNodes) return;
    state.nodes.forEach(n => {
      visNodes.update({ id: n.id, color: nodeColor(n) });
    });
  }

  function loadSelected(id) {
    const n = state.nodes.get(id);
    if (!n) return;
    $("selHint").textContent = "";
    $("selId").textContent = n.id;
    $("assignSelect").value = n.assignedTo || "";
    $("notes").value = n.notes || "";
    const col = nodeColor(n).background;
    $("selSwatch").style.background = col;
  }

  $("saveNodeBtn").addEventListener("click", () => {
    if (!state.selectedId) return;
    const n = state.nodes.get(state.selectedId);
    if (!n) return;
    n.assignedTo = $("assignSelect").value;
    n.notes = $("notes").value;
    refreshGraphStyles();
    loadSelected(n.id);
  });

  $("togglePinBtn").addEventListener("click", () => {
    if (!state.selectedId || !network) return;
    const n = state.nodes.get(state.selectedId);
    if (!n) return;

    n.fixed = !n.fixed;
    visNodes.update({ id: n.id, fixed: n.fixed ? {x:true,y:true} : false });
  });

  $("buildBtn").addEventListener("click", buildGraph);

  // --- Export/Import ---
  function exportPlan() {
    const payload = {
      version: 1,
      teams: state.teams,
      nodes: Array.from(state.nodes.values()),
      edges: Array.from(state.edges.values()),
      bg: { visible: state.bgVisible }
    };
    const json = JSON.stringify(payload, null, 2);
    navigator.clipboard.writeText(json).catch(() => {});
    alert("Exported plan JSON copied to clipboard.\n(If clipboard was blocked, you can manually copy from the prompt.)");
    prompt("Copy your plan JSON:", json);
  }

  function importPlan() {
    const raw = prompt("Paste plan JSON:");
    if (!raw) return;
    try {
      const payload = JSON.parse(raw);
      if (!payload || !payload.nodes || !payload.edges) throw new Error("Bad format");

      state.teams = payload.teams || state.teams;
      renderTeams();

      state.nodes = new Map((payload.nodes || []).map(n => [n.id, n]));
      state.edges = new Set(payload.edges || []);

      // Rebuild graph from imported state
      visNodes = new vis.DataSet(Array.from(state.nodes.values()).map(n => ({
        id: n.id,
        label: n.label || n.id,
        color: nodeColor(n),
        x: n.x ?? null, y: n.y ?? null,
        fixed: n.fixed ? {x:true,y:true} : false
      })));

      visEdges = new vis.DataSet(Array.from(state.edges.values()).map(k => {
        const [from,to] = k.split("|");
        return { id:k, from, to };
      }));

      network = new vis.Network($("network"), { nodes: visNodes, edges: visEdges }, {
        physics: { enabled: true, stabilization: false },
        interaction: { hover: true, multiselect: false },
        nodes: { shape: "dot", size: 14, font: { color: "#e7eefc" }, borderWidth: 2 },
        edges: { color: { color: "#2b3d60" }, width: 2, smooth: { type: "dynamic" } }
      });

      network.on("click", (params) => {
        if (params.nodes.length) {
          const id = params.nodes[0];
          state.selectedId = id;
          loadSelected(id);
        }
      });

      network.on("dragEnd", () => {
        const positions = network.getPositions();
        for (const [id, pos] of Object.entries(positions)) {
          const n = state.nodes.get(id);
          if (!n) continue;
          n.x = pos.x; n.y = pos.y;
        }
      });

      alert("Imported.");
    } catch (e) {
      alert("Could not import JSON: " + e.message);
    }
  }

  $("exportBtn").addEventListener("click", exportPlan);
  $("importBtn").addEventListener("click", importPlan);

  // --- Background image ---
  $("bgUpload").addEventListener("change", (ev) => {
    const file = ev.target.files?.[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    const img = $("bgImg");
    img.src = url;
    img.style.display = "block";
    state.bgVisible = true;
  });

  $("toggleBgBtn").addEventListener("click", () => {
    const img = $("bgImg");
    state.bgVisible = !state.bgVisible;
    img.style.display = state.bgVisible ? "block" : "none";
  });

  // --- Init ---
  renderTeams();

  // Small starter example so it boots immediately:
  $("adj").value =
`S7-A: S7-B,S7-C
S7-B: S7-D
S7-C: S7-D,S6-A
S6-A: S6-B
S6-B: S6-C`;

  buildGraph();
</script>
</body>
</html>
