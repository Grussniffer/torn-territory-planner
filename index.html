<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Torn Territory Planner</title>
  <style>
    :root{
      --bg:#000;
      --panel-bg: rgba(17,17,17,.92);
      --panel-border: rgba(255,255,255,.14);
      --text: #f3f4f6;
      --muted: rgba(255,255,255,.72);
      --stroke: rgba(255,255,255,.10);
      --neighbor-stroke: rgba(34,197,94,.95);
      --selected-stroke: rgba(250,204,21,.98);
      --war-stroke: rgba(239,68,68,.98);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;}
    #app{display:grid;grid-template-columns:minmax(320px, 380px) 1fr;height:100vh;}
    #panel{background:var(--panel-bg);border-right:1px solid var(--panel-border);padding:14px;overflow:auto;}
    #mapwrap{display:flex;align-items:center;justify-content:center;overflow:hidden;}
    #mapinner{position:relative;width:min(100%, 1200px);aspect-ratio:725/720;}
    #mapimg{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;}
    #overlay{position:absolute;inset:0;width:100%;height:100%;}
    .h1{font-size:18px;font-weight:700;margin:0 0 10px 0;}
    .row{display:flex;gap:10px;align-items:center;}
    label{display:block;font-size:12px;color:var(--muted);margin:12px 0 6px;}
    select, textarea{width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14);color:var(--text);border-radius:10px;padding:10px;outline:none;}
    textarea{min-height:90px;resize:vertical;}
    button{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);color:var(--text);border-radius:10px;padding:10px 12px;cursor:pointer;}
    button:hover{background:rgba(255,255,255,.12);}
    button.primary{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.35);}
    button.danger{background:rgba(239,68,68,.18);border-color:rgba(239,68,68,.35);}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid rgba(255,255,255,.14);border-radius:999px;background:rgba(255,255,255,.06);color:var(--muted);font-size:12px;}
    .swatch{width:10px;height:10px;border-radius:999px;display:inline-block;border:1px solid rgba(255,255,255,.25);}
    .small{font-size:12px;color:var(--muted);}
    .hr{height:1px;background:rgba(255,255,255,.12);margin:14px 0;}
    .list{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}

    /* SVG polygon styling */
    #overlay svg{width:100%;height:100%;}
    #overlay polygon{fill:rgba(0,0,0,0);stroke:var(--stroke);stroke-width:1;cursor:pointer;vector-effect:non-scaling-stroke;}
    #overlay polygon:hover{stroke:rgba(255,255,255,.55);stroke-width:2;}
    #overlay polygon.owned{fill:var(--own-fill, rgba(59,130,246,.25));stroke:rgba(255,255,255,.18);}
    #overlay polygon.neighbor{stroke:var(--neighbor-stroke);stroke-width:3;}
    #overlay polygon.selected{stroke:var(--selected-stroke);stroke-width:4;}
    #overlay polygon.war{stroke:var(--war-stroke);stroke-width:4;}
    #overlay polygon.war.selected{stroke-width:5;}

    @media (max-width: 900px){
      #app{grid-template-columns:1fr;grid-template-rows:auto 1fr;}
      #panel{border-right:none;border-bottom:1px solid var(--panel-border);}
    }
  </style>
</head>
<body>
<div id="app">
  <aside id="panel">
    <div class="row" style="justify-content:space-between;align-items:flex-start;">
      <div>
        <h1 class="h1">Territory Planner</h1>
        <div class="small">Click a territory to set owner + notes. Neighbors highlight in green.</div>
      </div>
      <div class="pill" title="Selected territory ID">
        <span class="swatch" id="selSwatch" style="background:rgba(255,255,255,.25)"></span>
        <span id="selId">None</span>
      </div>
    </div>

    <label for="ownerSel">Owner</label>
    <div class="row">
      <select id="ownerSel"></select>
      <button id="addOwnerBtn" title="Add a new owner/team">+ Add</button>
    </div>

    <label for="noteBox">Notes</label>
    <textarea id="noteBox" placeholder="Plan, targets, timers, calls..."></textarea>

    <div class="row" style="margin-top:10px;">
      <button class="primary" id="saveBtn">Save</button>
      <button class="danger" id="clearBtn" title="Clear owner + notes for selected territory">Clear</button>
    </div>

    <div class="hr"></div>

    <label>Neighbors</label>
    <div class="small" id="neighborsBox">Select a territory to see its neighbors.</div>

    <div class="hr"></div>

    <label>Data</label>
    <div class="row" style="flex-wrap:wrap;">
      <button id="exportBtn">Export plan</button>
      <button id="importBtn">Import plan</button>
      <button class="danger" id="resetBtn" title="Reset all saved data">Reset all</button>
    </div>

    <div class="small" style="margin-top:8px;">
      Stored locally (localStorage). Use Export/Import to share.
    </div>

    <div class="hr"></div>

    <label>Status</label>
    <div class="small">
      Neighbors: <span id="graphStatus">not loaded</span><br/>
      Wars: <span id="warsStatus">not loaded</span>
    </div>

    <div class="hr"></div>

    <label>Legend</label>
    <div class="list" id="legend"></div>
  </aside>

  <main id="mapwrap">
    <div id="mapinner">
      <img id="mapimg" src="map.png" alt="map"/>
      <div id="overlay"></div>
    </div>
  </main>
</div>

<script>
  // ---------- Storage ----------
  const LS_KEY = "tornTerritoryPlanner.v2";

  const defaultOwners = [
    { id: "unassigned", name: "Unassigned", color: "rgba(255,255,255,.12)" },
    { id: "blue", name: "Blue", color: "rgba(59,130,246,.35)" },
    { id: "pink", name: "Pink", color: "rgba(236,72,153,.35)" },
    { id: "green", name: "Green", color: "rgba(34,197,94,.35)" },
    { id: "yellow", name: "Yellow", color: "rgba(250,204,21,.35)" },
    { id: "red", name: "Red", color: "rgba(239,68,68,.35)" },
  ];

  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return { owners: defaultOwners, plan: {}, wars: [] };
      const s = JSON.parse(raw);
      return {
        owners: Array.isArray(s.owners) && s.owners.length ? s.owners : defaultOwners,
        plan: s.plan && typeof s.plan === "object" ? s.plan : {},
        wars: Array.isArray(s.wars) ? s.wars : [],
      };
    }catch{
      return { owners: defaultOwners, plan: {}, wars: [] };
    }
  }
  function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

  let state = loadState();

  // ---------- Data files ----------
  let graph = null; // territoryId -> [neighborIds]
  let polygons = [];

  async function loadSvgOverlay(){
    const res = await fetch("./territory_polygons_overlay.svg", { cache: "no-store" });
    if(!res.ok) throw new Error("territory_polygons_overlay.svg not found");
    const svgText = await res.text();
    document.getElementById("overlay").innerHTML = svgText;
    const svg = document.querySelector("#overlay svg");
    polygons = Array.from(svg.querySelectorAll("polygon"));
  }

  async function tryLoadGraph(){
    try{
      const res = await fetch("./connections.json", { cache: "no-store" });
      if(!res.ok) throw new Error("connections.json not found");
      const payload = await res.json();
      graph = payload.territories_neighbors || payload;
      if(!graph || typeof graph !== "object") throw new Error("bad graph");
      document.getElementById("graphStatus").textContent = "loaded";
    }catch{
      graph = null;
      document.getElementById("graphStatus").textContent = "not loaded";
    }
  }

  async function tryLoadWars(){
    try{
      const res = await fetch("./wars.json", { cache: "no-store" });
      if(!res.ok) throw new Error("wars.json not found");
      const payload = await res.json();
      // expects: { wars: ["12","500", ...] } OR ["12","500"...]
      const list = Array.isArray(payload) ? payload : (payload.wars || []);
      state.wars = list.map(String);
      saveState();
      document.getElementById("warsStatus").textContent = "loaded";
    }catch{
      document.getElementById("warsStatus").textContent = "not loaded";
    }
  }

  // ---------- UI ----------
  const $ = (id) => document.getElementById(id);
  const ownerSel = $("ownerSel");
  const noteBox = $("noteBox");
  const selId = $("selId");
  const selSwatch = $("selSwatch");
  const neighborsBox = $("neighborsBox");
  const legend = $("legend");

  function terrIdForPoly(poly){
    // your SVG already has data-comp that matches the neighbor graph keys
    return String(poly.getAttribute("data-comp") || poly.id.replace(/^t/, ""));
  }

  function ownerById(id){
    return state.owners.find(o => o.id === id) || state.owners[0];
  }

  function renderOwners(){
    ownerSel.innerHTML = "";
    for(const o of state.owners){
      const opt = document.createElement("option");
      opt.value = o.id;
      opt.textContent = o.name;
      ownerSel.appendChild(opt);
    }
    renderLegend();
  }

  function renderLegend(){
    legend.innerHTML = "";
    for(const o of state.owners.filter(x => x.id !== "unassigned")){
      const div = document.createElement("div");
      div.className = "pill";
      div.innerHTML = `<span class="swatch" style="background:${o.color}"></span><span>${o.name}</span>`;
      legend.appendChild(div);
    }
  }

  function applyPlanToMap(){
    for(const poly of polygons){
      const id = terrIdForPoly(poly);
      const entry = state.plan[id];

      poly.classList.remove("owned");
      poly.style.removeProperty("--own-fill");

      if(entry && entry.ownerId && entry.ownerId !== "unassigned"){
        const o = ownerById(entry.ownerId);
        poly.classList.add("owned");
        poly.style.setProperty("--own-fill", o.color);
      }

      poly.classList.toggle("war", state.wars.includes(id));
    }
  }

  let selectedId = null;
  function clearSelectionStyles(){
    polygons.forEach(p => p.classList.remove("selected", "neighbor"));
  }

  function setSelected(id){
    selectedId = id;
    selId.textContent = id || "None";
    clearSelectionStyles();

    if(!id){
      neighborsBox.textContent = "Select a territory to see its neighbors.";
      ownerSel.value = "unassigned";
      noteBox.value = "";
      selSwatch.style.background = "rgba(255,255,255,.25)";
      return;
    }

    const poly = polygons.find(p => terrIdForPoly(p) === id);
    if(poly) poly.classList.add("selected");

    const entry = state.plan[id] || { ownerId: "unassigned", note: "" };
    ownerSel.value = entry.ownerId || "unassigned";
    noteBox.value = entry.note || "";

    const o = ownerById(ownerSel.value);
    selSwatch.style.background = o.color || "rgba(255,255,255,.25)";

    if(!graph){
      neighborsBox.textContent = "Neighbor graph not loaded. Add connections.json to enable.";
      return;
    }

    const neigh = graph[id] || graph[Number(id)] || [];
    const neighIds = neigh.map(String);
    neighborsBox.textContent = neighIds.length ? neighIds.join(", ") : "(none)";
    for(const p of polygons){
      if(neighIds.includes(terrIdForPoly(p))) p.classList.add("neighbor");
    }
  }

  function wireMapClicks(){
    polygons.forEach(poly => {
      poly.addEventListener("click", (e) => {
        e.preventDefault(); e.stopPropagation();
        setSelected(terrIdForPoly(poly));
      });
    });
    document.querySelector("#mapinner").addEventListener("click", () => setSelected(null));
  }

  // buttons
  $("saveBtn").addEventListener("click", () => {
    if(!selectedId) return;
    const ownerId = ownerSel.value;
    const note = noteBox.value || "";
    if(ownerId === "unassigned" && !note.trim()){
      delete state.plan[selectedId];
    }else{
      state.plan[selectedId] = { ownerId, note };
    }
    saveState();
    applyPlanToMap();
    setSelected(selectedId);
  });

  $("clearBtn").addEventListener("click", () => {
    if(!selectedId) return;
    delete state.plan[selectedId];
    saveState();
    applyPlanToMap();
    setSelected(selectedId);
  });

  ownerSel.addEventListener("change", () => {
    const o = ownerById(ownerSel.value);
    selSwatch.style.background = o.color;
  });

  $("addOwnerBtn").addEventListener("click", () => {
    const name = prompt("Owner/team name?");
    if(!name) return;
    const color = prompt("CSS color (e.g. rgba(59,130,246,.35) or #ff00ff33)", "rgba(59,130,246,.35)") || "rgba(255,255,255,.18)";
    const id = name.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9\-]/g,"").slice(0,24) || ("owner-" + Math.random().toString(16).slice(2,8));
    state.owners.push({ id, name, color });
    saveState();
    renderOwners();
  });

  $("exportBtn").addEventListener("click", () => {
    const payload = JSON.stringify(state, null, 2);
    const blob = new Blob([payload], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "territory-plan.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  $("importBtn").addEventListener("click", async () => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/json";
    input.onchange = async () => {
      const file = input.files && input.files[0];
      if(!file) return;
      const text = await file.text();
      try{
        const parsed = JSON.parse(text);
        state = {
          owners: Array.isArray(parsed.owners) && parsed.owners.length ? parsed.owners : state.owners,
          plan: parsed.plan && typeof parsed.plan === "object" ? parsed.plan : {},
          wars: Array.isArray(parsed.wars) ? parsed.wars.map(String) : [],
        };
        saveState();
        renderOwners();
        applyPlanToMap();
        setSelected(selectedId);
      }catch{
        alert("Invalid JSON.");
      }
    };
    input.click();
  });

  $("resetBtn").addEventListener("click", () => {
    if(!confirm("Reset all saved owners + plans?")) return;
    localStorage.removeItem(LS_KEY);
    state = { owners: defaultOwners, plan: {}, wars: [] };
    saveState();
    renderOwners();
    applyPlanToMap();
    setSelected(null);
  });

  // boot
  (async () => {
    renderOwners();
    await loadSvgOverlay();
    await tryLoadGraph();
    await tryLoadWars();
    wireMapClicks();
    applyPlanToMap();
  })();
</script>
</body>
</html>
